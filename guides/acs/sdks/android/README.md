# Appcelerator Platform Services SDK for Android -- Appcelerator Cloud Services

The Appcelerator Platform Services (APS) SDK for Android provides APIs for your native Android 
application to access Appcelerator Cloud Services (ACS). 

## Getting the SDK ##

To download the SDK, you visit [Appcelerator Dashboard](https://dashboard.appcelerator.com) and [create
a new Android application](http://docs.appcelerator.com/platform/latest/#!/guide/Managing_Native_Applications_in_Dashboard) to generate the required application keys and allocate server resources. For detailed steps for creating a new native application in Dashboard and enabling Platform services in your application, 
see [Managing_Native_Applications_in_Dashboard](http://docs.appcelerator.com/platform/latest/#!/guide/Managing_Native_Applications_in_Dashboard).

See also:

* [Running the APSCloudExample Application](#)
* [Enabling the Cloud service in a new Project](#)

## Running the APSCloudExample Application ##

The SDK includes an Android sample project that demonstrates basic use of each of the APS Cloud APIs. 
To run the sample you first need to create a new application in Dashboard, and copy the generated 
application key into the sample application's main Activity class.

**To create the APSCloudExample application in Dashboard:**

1. Login to [Appcelerator Dashboard](https://dashboard.appcelerator.com).
2. From the Orgs menu, select the organization to associate with the application.
3. Click the Apps menu and select **Add a Native App**.
4. In the dialog that appears enter **APSCloudExampleApp**.
5. Click **Next** and then click the **Overview** tab.
6. Click the **Services** tab, then click **Show Key** under **Cloud /  Performance /  Analytics**.
7. Select **Development** from the Environment menu, then click the clipboard icon to copy the key
to your clipboard.

Next, you'll import the APSCloudExample project into Eclipse, copy the key from your clipboard
into the application's main activity, and run the application.

**To import the Cloud example project:**

1. In ADT, select **File > Import > General > Existing Code into Workspace**, then click **Next**.
2. Click Browse and navigate to the **appcelerator-sdk-android-1.0/examples/APSCloudExample** folder, and click Open.
3. Click Finish.
4. Open **src/main/java/com/appcelerator/apscloudexample/MainActivity.java**.
5. Locate the following line of code and replace **<< YOUR APP KEY >>** with the application key you 
copied to your clipboard previously.

        String appKey = "<< YOUR APP KEY >>";

6. Run the application on an Android device or emulator. 

Once the application is running, try the following:

* Create a new user by selecting **Users > Create User**. Enter a username, password and password confirmation
and then click **Create**. If the user is created successfully, the following dialog is shown: 

{@img new_user_success.png}

* View the newly created user in Dashboard:
    1. Open [Dashboard](https://dashboard.appcelerator.com) and select your application from the Apps menu.
    2. Select **Cloud > Manage Data**, then click **Users** in the Manage Data Object table. You
    should see the user you created listed in the Users table.
    
{@img verify_new_user.png}

## Enabling the Cloud service in a new Project

Once you've [created an application in Dashboard](, downloaded the SDK, and obtained your application service
key, there are just a few steps to enable Cloud service in your Android project.

**To enable the Cloud service in your project**:

1. Copy **appcelerator-sdk-android-1.0.0.jar** to your project's libs folder.
2. Add the `<uses-permission android:name="android.permission.INTERNET"/>` permission to your project's
AndroidManifest.xml file. 
3. Import the APSServiceManager class into the project's main Activity: 

        import com.appcelerator.aps.APSServiceManager;
4. Call `APSServiceManager.getInstance().enable()`, passing it the application context, and your application
key generated by Dashboard when you created the application:

        APSServiceManager.getInstance().enable(getApplicationContext(), "<<YOUR APP KEY>>");        


### Session Management

Many Cloud API calls require a valid session, which is obtained by a successful call to the `APSUsers.login()`. To create an ACS account and username, call the `APSUsers.create()` method. You must specify at least a username or e-mail, and a password when creating a new user.

Currently, sessions with the Cloud service are not persisted by the framework between application launches. 
You can check if you have a valid session ID by calling `APSUsers.showMe()`, which will fail if
a session does not exist.

## Making API Calls and Handling Responses

The `com.appcelerator.cloud.objects ` package contains a collection of classes whose methods map to 
individual REST API method endpoints. For example, the `APSUsers.create()` method corresponds to the
[`/users/create.json`](http://docs.appcelerator.com/cloud/latest/#!/api/Users-method-create) method
endpoint. Alternatively, you can use the generic [APSCloud.sendRequest()](com/appcelerator/aps/APSCloud.html#sendRequest(java.lang.String, java.lang.String, java.util.Map, com.appcelerator.aps.APSResponseHandler)) method to make REST calls directly 
against the Cloud APIs. For details on using the generic method, see [Making Generic REST API Calls](#).

Response data is JSON-encoded.

Each Cloud method must be enclosed in `try/catch` block that handles an exception of type `APSCloudException`.
This type of exception occurs before any method calls over the network are initiated.

    try {
        APSPhotos.show(data, new APSResponseHandler() {                
            @Override
            public void onResponse(final APSResponse e) {
                if (e.getSuccess()) {
                    // Parse JSON response
                } else {
                    // Handle error
                }
            }
        });
    } catch (APSCloudException e) {
        // Handle APSCloudExcpetion
    }


Each method takes a `data` parameter, which is a `HashMap` containing the data to send with the request.
Pass `null` if the method doesn't require any input.

The second parameter of each Cloud object method takes an instance of [APSResponseHandler](http://docs.appcelerator.com/aps-sdk-apidoc/latest/android/com/appcelerator/cloud/APSResponseHandler.html), which is an interface. The instance must override the following methods:

* An `onResponse()` method to handle the server's response. This method is passed an [APSResponse](http://docs.appcelerator.com/aps-sdk-apidoc/latest/android/com/appcelerator/cloud/APSResponse.html) object that contains the response data, as well as
meta-data about the request.
* An`onException()` handler that is invoked for any errors that occur during the API call.



APSCloud methods execute the callback handlers in the background. To update the UI,
the application needs to execute the code in the UI thread, which requires a reference to the
current activity.

These methods may throw an exception and must be contained in a try-catch block or add a `throws
APSClientError` declaration to the method.

### APSUsers Login Call with Response Handler

The following example logs in an ACS user.  After a successful call, the application updates a label
with the ACS username.

    HashMap<String, Object> data = new HashMap<String, Object>();
    data.put("login", "username");
    data.put("password", "password");

    try {
        APSUsers.login(data, new APSResponseHandler() {
            @Override
            public void onResponse(final APSResponse e) {
                if (e.getSuccess()) {
                    try {
                        JSONObject res = e.getResponse();
                        // Response returns an array containing a single user
                        JSONArray payload = res.getJSONArray("users");
                        res = payload.getJSONObject(0);
                        loginTextView.setText(res.getString("username"));
                    } catch (Exception e) {
                        Log.e("LOGIN", "Error parsing JSON object: " + e.toString());
                    }
                }
                else {
                    Log.e("LOGIN", e.getMessage());
                }
                
            }
            @Override
            public void onException(APSCloudException e) {
                // Handle exception that occured                
            }
        });
    } catch (APSClientError e) {
        Log.e("LOGIN", e.getErrorType());
    }

### APSFiles Create Call with Progress Handler

For Cloud API methods that may involve uploading large files, such as `APSPhotos.create()` or `APSFiles.create()`, 
there is an overloaded version that takes an optional `progressHandler` parameter. This parameter takes
a [APSProgressHandler](http://docs.appcelerator.com/aps-sdk-apidoc/latest/android/com/appcelerator/cloud/APSProgressHandler.html)
instance, which must provide an `onProgress` handler. This handler is periodically triggered as the file
transfer continues, and is passed an integer between 0-100 indicating the current upload progress.

The following example uploads a file from the device (`/res/raw/reference.pdf`) to the ACS storage server. 
Since the method call requires that uploaded data be an instance of `java.io.File`, the application needs to copy the
resource to a read-write directory before uploading it. Storing the file locally requires that the 
[WRITE_EXTERNAL_STORAGE](http://developer.android.com/reference/android/Manifest.permission.html#WRITE_EXTERNAL_STORAGE) 
permission be included in your AndroidManifest.xml file.

The progress callback calls the `setProgress() ` method on a `ProgressBar` object., displaying the 
status of the upload. After the request successfully completes, the application displays a toast notification.

    HashMap<String, Object> data = new HashMap<String, Object>();
    String filename = "reference.pdf";

    // Need to copy the resource to a read-write directory to upload it 
    if (!createExternalStoragePrivateFile(R.raw.reference, filename)) return;

    File file = new File(currentActivity.getExternalFilesDir(null), filename);
    data.put("file", file);
    data.put("name", "Reference Manual");

    try {
        APSFiles.create(data, new APSClient.APSResponseHandler() {
            @Override
            public void onResponse(final APSResponse e) {
                if (e.getSuccess()) {
                    APSCloud.log("PUSH", "Successfully subscribed to push!");
                    progressBar.setVisibility(View.GONE);
                    Toast.makeText(currentActivity, "File uploaded!", Toast.LENGTH_SHORT).show();
                }
                else {
                    Log.e("UPLOAD", e.getMessage());
                }
            }
        },
        new APSClient.APSProgressHandler() {
            @Override
            public void onProgress(final int percentProgress, final boolean upload) {
                if (currentActivity != null) {
                    progressBar.setProgress(percentProgress);
            }
        });
    } catch (APSClientError e) {
        Log.e("UPLOAD", e.getMessage());
    }

    // Helper function to copy a resource to external storage, modified from:
    // http://developer.android.com/reference/android/content/Context.html#getExternalFilesDir(java.lang.String)

    public static boolean createExternalStoragePrivateFile(int inputResource, String filename) {
        File file = new File(currentActivity.getExternalFilesDir(null), filename);
        try {
            InputStream is = currentActivity.getResources().openRawResource(inputResource);
            OutputStream os = new FileOutputStream(file);
            byte[] data = new byte[is.available()];
            is.read(data);
            os.write(data);
            is.close();
            os.close();
            return true;
        } catch (IOException e) {
            Log.w("ExternalStorage", "Error writing " + file, e);
            return false;
        }
    }

### Making Generic REST APIs Method Calls 

The APSClient class's `sendRequest()` method lets you easily make REST API calls directly against
ACS, rather than using the specialized classes, such as `APSUsers`. In general, use the
specialized classes as they are easier to work with. However, it may be useful or
necessary to make REST calls directly in some cases. For instance, if new REST APIs are deployed to
the APS Cloud backend, you can immediately start using that API without having to wait for an update
to the APS SDK.

To make a generic request, get a reference to the APSClient object's `sharedClient` property and call
its `sendRequest()` method. For each call, you must specify the following:

  * REST API method endpoint (relative to `baseURL`). Method endpoints are listed in the REST API documentation.
  * The HTTP method to use.
  * Data to send with the request.

For example, to [create a post](http://docs.appcelerator.com/cloud/latest/#!/api/Posts-method-create),
pass the `sendRequest()` method the following information:

  * REST API method endpoint: `posts/create.json`
  * The HTTP method to use: `POST`
  * Data to send with the request: at minimum, you must specify the `content` property.

The following uses the `sendRequest()` API to create a new Post object.

    APSClient client = APSClient.sharedClient();
    HashMap<String, Object> data = new HashMap<String, Object>();
    data.put("title", "What's up?");
    data.put("content", "The sun, the cloud, space...");

    try {
        client.sendRequest("posts/create.json", "POST", data, new APSClient.APSResponseHandler() {
            public void onResponse(final APSResponse e) {
                if (e.getSuccess()) {
                    try {
                        JSONObject res = e.getResponse();
                        JSONArray payload = res.getJSONArray("posts");
                        res = payload.getJSONObject(0);
                        latestPost.setText(res.getString("title"));
                    } catch (Exception err) {
                        Log.e("REST", "JSON Error: " + err.getMessage());
                    }
                }
                else {
                    Log.e("REST", e.getMessage());
                }
            }
        });
    } catch (APSClientError e) {
        Log.e("REST", "Error: " + e.getMessage());
    }

## Working with Push Notifications

The `APSCloudPush` class lets you send and receive push notifications. 

* To use this class, your application must include Google Play Services. See 
[Setting Up Google Play Services](http://developer.android.com/google/play-services/setup.html) for details.
* Your application must first call `APSServiceManager.enable()` before calling any methods on `APSCloudPush`.

### Push notification configuration

To use push notifications you must configure your application in Dashboard with your Google Cloud Messaging (GCM)
API key and sender ID. For instructions, see [Configuring push services for Android devices](/platform/latest/#!/guide/Configuring_push_services-section-37551713_Configuringpushservices-ConfiguringpushservicesforAndroiddevices).

## Sample Application
