
# Node.ACS MVC Framework

The Node.ACS MVC framework is an ease-of-use web application framework that
provides a standard MVC framework like Ruby on Rails or J2EE. The Node.ACS
framework defines URL routing, filtering, and starts a web server in one
simple command. Working with this framework, all you have to do is to focus on
your application's features.

This framework and web server are built based on the Express web application framework
(version 3.0.0). The MVC framework also includes a websocket server based on socket.io (0.9.10). 

The framework parses and loads routes, filters and websockets configurations, and sets them 
up before starting the Express and socket.io servers. Applications can add their
own `start` and `stop` functions to set up server settings before
starting the server and to release resources before stopping the server. 

## Application Startup and Shutdown

This section describes what Node.ACS does when starting or stopping your
application. 

### Application Startup Sequence 

A Node.ACS application can be started locally (in the development environment) for
developing/testing purposes by using the [**acs run**](#!/guide/cli/run) command. Once
published to the cloud, it is automatically started. When an application using
the Node.ACS MVC framework is started (locally or in cloud), the
following process takes place:

1.  Initialize Express and socket.io servers.

    For both servers, the framework loads some default configuration settings.

    Settings for Express:

    * `app.use(express.methodOverride())`
    * `app.use(express.cookieParser())`
    * `app.use(connect.query())`
    * `app.use(express.bodyParser())`
    * `app.set('view engine', 'ejs')`
    * set "public" folder as static files root
    * set "views" folder as view files root

    Settings for socket.io:

    * io.enable('browser client etag')
    * io.enable('browser client minification')
    * io.enable('browser client gzip')
    * io.set('log level', 1)
    * io.set("polling duration", 10)
    * io.set('transports', [ 'websocket', 'htmlfile', 'xhr-polling', 'jsonp-polling' ])

2.  Load the main script file and execute its "start" function (if it exists), passing
    in the Express server object.

    If a function defined as `function start(app, express)` in the application's
    main script file (`app.js` by default), it will be called by the framework,
    passing in the "app" and "express" objects. This allows the application to 
    modify the default application configuration before the servers start.

3.  Setup routes, filters and websockets.

    The framework loads all configuration items for routes, filters and websockets
    in the applicaton's configuration file (`config.js`), and will set filters and
    routes to the express server, and websocket event handling to the socket.io
    server.

4.  Start server to listen on service port.

    The framework calls the `listen` method of the HTTP server to start the Express
    server. The socket.io server will also be started and will listen on the same
    port.

### Application Shutdown Sequence

When an application is shut down (locally or in the cloud), the
following process takes place:

1.  Execute the `stop` function in main script file.

    If a function defined as `function stop()` in the application's main script
    file (`app.js` by default), it will be called by the framework before stopping
    the servers. You can use this to release any application resources.

2. Stop listening on the service port.

3. Shut down the servers.

## Project Structure   

A typical Node.ACS application developed using the Node.ACS MVC framework
contains the following files/directories:

  * **package.json** \-- application configuration file that contains all configuration items of the app
  * **app.js** \-- main entrance script which loads the application; the field "main" in `package.json` indicates which file in the application is the main entrance script to load
  * **config.json** \-- definitions of the application's router, filter and websocket events
  * **controllers** \-- the directory for routing handlers
  * **filters** \-- the directory for filter handlers
  * **websockets** \-- the directory for websocket event handlers
  * **logs** \-- the directory for log files generated by the application when running locally
  * **public** \-- the root directory for application static files
  * **views** \-- the directory for application viewer files

### package.json

The basic configuration file for a Node.ACS application.  
    
    {
      "name": "MyNodeACSApp",
      "main": "app.js",
      "framework": "mvc",
      "version": "0.1.0",
      "description": "My first Node.ACS MVC App!",
      "author": "sam@nodeacs.com",
      "dependencies": {
        "mongodb": "1.0.2"
      },
      "logfile" : "MyNodeACSApp.log",
      "engines" : { "node": "0.10.22" }
    }
    

Important fields are summarized below (* indicates mandatory fields):

* **name*** \-- the name of app, an app's name is unique across all the apps of a user. It will be used to ID the app when publishing/unpublishing to cloud, or setup the app through CLI commands
* **main*** \-- the main entrance script file for Node.ACS to load to start the application
* **framework*** \-- the "type" of app, if the value is "mvc", Node.ACS will run it as an app with the MVC framework.
* **dependencies** \-- app dependencies, when an app starts, every modules declared here will be installed before starting the app
* **logfile** \-- log file's name, log file will be placed in "logs" folder
* **engines** \-- contains key-value pairs of engine versions.  Use this field to specify the version
of Node.js to run your application on. Use `node` as the key and the version or version range as the
value.  For more details, see the "Node.js Engine" section in [Standard Node.js Applications](#!/guide/node_standard).

### app.js

Main script file for Node.ACS to load and start the app. If the app is using
the MVC framework, the `start` and `stop` functions are invoked during application
startup and shutdown, respectively. 
    
    // setup app session and favicon
    function start(app, express) {
        app.use(express.session(
                { key: 'node.acs', secret: "my secret" }));
        app.use(express.favicon(
                __dirname + '/public/images/favicon.ico'));
    }
    
    function stop() {
        // release resources before server stop
    }
    

The `start` or `stop` functions are both optional; if they are not defined, the startup
and shutdown sequence proceeds as described above.

### config.json

The configuration file for defining the application's url routing, filters and
websockets.
    
    {
      "routes":
      [
        {"path": "/", "method": "get", "callback": "home#index"},
        {"path": "/login", "method": "post", "callback": "users#login"}
      ],
      "filters":
      [
        {"path": "/", "callback": "session_filter#validateSession"},
        {"path": "/users", "callback": "users#validateUser"}
      ],
      "websockets":
      [
        {"event": "msg", "callback": "chat#domsg"},
        {"event": "scores", "callback": "game#postScores"}
      ]
    }
    

* **routes** \-- Each router definition has 'path', 'method' and 'callback' which maps a URL path to a certain handler(function) through a certain http method (one of 'get', 'post', 'put', 'delete' and 'options'). The 'method' is not case sensitive and is optional, if no method defined, the routes will be treated as GET. The handler is combined with controller's name and its function name, joined by '#'. The controller's name should be the same as file's name in 'controllers' folder.
* **filters** \-- Filters are defined the same as controllers, except for it doesn't have 'method'. Matched request URL with any method will be intercept by the filter. All filters are placed under "filters" folder.
* **websockets** \-- The websockets defines event-handler mappings, whenever a websocket client emits a certain event, take 'msg' event here as an example, the 'domsg' function in /websockets/user.js file will be invoked to handle the request.
  
For example, the URL path "/" will be handled by the `index` function in
`/controllers/home.js`. The 'index' function should be declared as 

    function index(req, res) { 
        // implementation 
    }

### Controller

The HTTP request handler (function) for handling a certain request URL path
defined in `config.json`.
  
**/controllers/users.js**
    
    function login(req, res) {
      //do user login here
      if(req.params.username == 'test' 
            && req.params.password == 'test') {
        res.render('index');
      } else {
        res.render('error');
      }
    }
    

Node.ACS uses Express to handle routing internally, the "req" and "res" are
standard Express request, response object.  
All controller files reside in "controllers" folder with '.js' extension.
There could be any number of controller files in an application, and could be
any number functions in a controller file.

### Filter

A function will be called whenever a request URL path matched the defined path
in `config.json`.

  
**/filters/session_filter.js**
    
    
    function validateSession(req, res, next) {
      if(!req.session.user) {
        res.send('Unauthenticated!');
      } else {
        next();
      }
    }
    

Node.ACS uses `app.all()` internally to setup the filters, all filters will be
set before routes so that it can be reached before the request gets handled by
controllers.  
All filter files reside in "filters" folder with '.js' extension. There could
be any number of filter files in an application, and there could be any number
of functions in a filter file.

### Websocket

A function will be called whenever a websocket event defined in `config.json`
is triggered.

  
**/websockets/chat.js**
    
    
    function domsg(data, socket) {
      // broadcast received message to all connected clients
      socket.broadcast.emit('message', data);
    }
    

Node.ACS uses socket.io internally as websocket server, the "communication"
between server and client is through the "event" emitting. The client could be
any standard socket.io client. Node.ACS server also provides a socket.io
javascript client, it can be downloaded from your app through URL:  
http://<your app's url>/socket.io/socket.io.js  
All websocket files reside in "websockets" folder with '.js' extension. There
could be any number of websocket files in an application, and could be any
number functions(event handlers) in a websocket file.

### Logs

All log files are placed in the "logs" folder, the log file's name is defined
by the "logfile" field in `config.json`, if it is not configured, the log file
name will be the project's name.

### Public

All application's static files are placed in the "public" folder, it usually
contains stylesheets, image assets and script files.

### View

All application's view files are placed in the "views" folder, the Node.ACS
MVC framework uses "ejs" as view engine by default. Other view engines can be
set through the "start" function in the main script file.

## Add a New Controller (Route)

One of the most common features of web applications are to define the URL
routing and handler (controller). With the Node.ACS MVC framework, you can
easily do this by following the instructions above. Node.ACS also provides a
utility CLI command that can help you to quickly generate a code stub of route
and controller. See the [**acs add**](#!/guide/cli/add) command for more details.

## For More Information

*   See the [Express web site](http://expressjs.com) for guides and API reference
    documentation for the Express web application framework.

*   See the [socket.io web site](http://socket.io) for more information on using
    socket.io websockets.
